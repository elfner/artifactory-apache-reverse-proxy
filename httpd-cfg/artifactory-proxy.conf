###########################################################
## this configuration was generated by JFrog Artifactory ##
###########################################################

## add HA entries when ha is configured
<Proxy balancer://artifactory>
    BalancerMember http://openshiftartifactoryha-artifactory-ha-primary:8082 route=openshiftartifactoryha-artifactory-ha-primary-0
ProxySet lbmethod=byrequests
ProxySet failonstatus=503
</Proxy>
<Proxy balancer://artifactory-direct>
    ## servers with the Artifactory ports. Note that the port is the default one, if you configured differently it must be changed
    BalancerMember http://openshiftartifactoryha-artifactory-ha-primary:8081 route=openshiftartifactoryha-artifactory-ha-primary-0
ProxySet lbmethod=byrequests
ProxySet failonstatus=503
</Proxy>
<VirtualHost *:80>

    ProxyPreserveHost On
    ProxyAddHeaders off

    ServerName artifactory.apps.ocpcarrier2.test.fdc.ibm
    ServerAlias *.artifactory.apps.ocpcarrier2.test.fdc.ibm
    ServerAdmin server@admin


    ## Application specific logs
    ## ErrorLog ${APACHE_LOG_DIR}/artifactory.apps.ocpcarrier2.test.fdc.ibm-error.log
    ## CustomLog ${APACHE_LOG_DIR}/artifactory.apps.ocpcarrier2.test.fdc.ibm-access.log combined

    AllowEncodedSlashes On
    RewriteEngine on

    RewriteCond %{SERVER_PORT} (.*)
    RewriteRule (.*) - [E=my_server_port:%1]
    ##  NOTE: The 'REQUEST_SCHEME' Header is supported only from apache version 2.4 and above
    RewriteCond %{REQUEST_SCHEME} (.*)
    RewriteRule (.*) - [E=my_scheme:%1]

    RewriteCond %{HTTP_HOST} (.*)
    RewriteRule (.*) - [E=my_custom_host:%1]

    RewriteCond "%{REQUEST_URI}" "^/(v1|v2)/"
    RewriteCond "%{HTTP_HOST}" "^(.*)\.artifactory.apps.ocpcarrier2.test.fdc.ibm$"
    RewriteRule "^/(v1|v2)/(.*)$" "/artifactory/api/docker/%1/$1/$2" [PT]

    RewriteRule ^(/)?$      /ui/ [R,L]
    RewriteRule ^/ui$      /ui/ [R,L]

    RequestHeader set Host %{my_custom_host}e
    RequestHeader set X-Forwarded-Port %{my_server_port}e
    ## NOTE: {my_scheme} requires a module which is supported only from apache version 2.4 and above
    RequestHeader set X-Forwarded-Proto %{my_scheme}e
    RequestHeader set X-JFrog-Override-Base-Url %{my_scheme}e://artifactory.apps.ocpcarrier1.test.fdc.ibm:%{my_server_port}e
    ProxyPassReverseCookiePath / /

    ProxyRequests off
    ProxyPreserveHost on
    ProxyPass "/artifactory/" balancer://artifactory-direct/artifactory/
    ProxyPassReverse "/artifactory/" balancer://artifactory-direct/artifactory/
    ProxyPass "/" balancer://artifactory/
    ProxyPassReverse "/" balancer://artifactory/
</VirtualHost>

<VirtualHost *:8443>

    ProxyPreserveHost On
    ProxyAddHeaders off

    ServerName artifactory.apps.ocpcarrier1.test.fdc.ibm
    ServerAlias *.artifactory.apps.ocpcarrier1.test.fdc.ibm
    ServerAdmin server@admin

    SSLEngine on
    SSLCertificateFile /etc/ssl/tls.crt
    SSLCertificateKeyFile /etc/ssl/tls.key
    SSLProxyEngine on

    ## Application specific logs
    ## ErrorLog ${APACHE_LOG_DIR}/artifactory.apps.ocpcarrier1.test.fdc.ibm-error.log
    ## CustomLog ${APACHE_LOG_DIR}/artifactory.apps.ocpcarrier1.test.fdc.ibm-access.log combined

    AllowEncodedSlashes On
    RewriteEngine on

    RewriteCond %{SERVER_PORT} (.*)
    RewriteRule (.*) - [E=my_server_port:%1]
    ##  NOTE: The 'REQUEST_SCHEME' Header is supported only from apache version 2.4 and above
    RewriteCond %{REQUEST_SCHEME} (.*)
    RewriteRule (.*) - [E=my_scheme:%1]

    RewriteCond %{HTTP_HOST} (.*)
    RewriteRule (.*) - [E=my_custom_host:%1]

    RewriteCond "%{REQUEST_URI}" "^/(v1|v2)/"
    RewriteCond "%{HTTP_HOST}" "^(.*)\.artifactory.apps.ocpcarrier1.test.fdc.ibm$"
    RewriteRule "^/(v1|v2)/(.*)$" "/artifactory/api/docker/%1/$1/$2" [PT]

    RewriteRule ^(/)?$      /ui/ [R,L]
    RewriteRule ^/ui$      /ui/ [R,L]

    RequestHeader set Host %{my_custom_host}e
    RequestHeader set X-Forwarded-Port %{my_server_port}e
    ## NOTE: {my_scheme} requires a module which is supported only from apache version 2.4 and above
    RequestHeader set X-Forwarded-Proto %{my_scheme}e
    RequestHeader set X-JFrog-Override-Base-Url %{my_scheme}e://artifactory.apps.ocpcarrier1.test.fdc.ibm:%{my_server_port}e
    ProxyPassReverseCookiePath / /

    ProxyRequests off
    ProxyPreserveHost on
    ProxyPass "/artifactory/" balancer://artifactory-direct/artifactory/
    ProxyPassReverse "/artifactory/" balancer://artifactory-direct/artifactory/
    ProxyPass "/" balancer://artifactory/
    ProxyPassReverse "/" balancer://artifactory/
</VirtualHost>
